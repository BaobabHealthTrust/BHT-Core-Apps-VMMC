<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html;charset=UTF-8" />

    <script language="javascript" defer="true">
      tstUsername = "";

    </script>

    <script type="text/javascript" src="/public/touchscreentoolkit/lib/javascripts/touchScreenToolkit.js"
        defer="true"></script>
    <script type="text/javascript" src="/assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/moment.js"></script>
    <script type="text/javascript" src="/apps/VMMC/assets/js/common.js"></script>

    <script type="text/javascript" src="/assets/js/post_parameters.js"></script>
    <script type="text/javascript" src="/assets/js/generic_ajaxrequest.js"></script>
    <script type="text/javascript" src="/assets/js/alertifyjs/alertify.js"></script>
    <script type="text/javascript" src="/assets/js/does_connection_exist.js"></script>
    <script type="text/javascript" src="/assets/js/moment.js"></script>
    <link rel="stylesheet" href="/assets/css/alertifyjs/css/alertify.css" type="text/css">


  </head>
  <body id="mateme">
    <div id="container">
      <div id="content">
        <style type="text/css">
  
        </style>

<form>

  <select name="known_hiv_positive" 
  id="known_hiv_positive" 
  tt_pageStyleClass="NoKeyboard" 
  allowFreeText="false" 
  tt_onLoad="showCategory2('HIV/ART status');" 
  helpText="Known HIV+ (Documented test results)"><option value=''></option>
  <option value=""></option>
  <option value="Yes">Yes</option>
  <option value="No">No</option></select>

  <select name="currently_taking_arvs" 
  id="currently_taking_arvs" 
  tt_pageStyleClass="NoKeyboard" 
  allowFreeText="false" 
  tt_onLoad="showCategory2('HIV/ART status');"
  helpText="Currently taking ARVs?"><option value=''></option>
  <option value=""></option>
  <option value="Yes">Yes</option>
  <option value="No">No</option></select>

  <select name="hiv_test_done_today" 
  id="hiv_test_done_today?" 
  tt_pageStyleClass="NoKeyboard" 
  allowFreeText="false"
  tt_onLoad="showCategory2('HIV/ART status');" 
  helpText="HIV Test done today?"><option value=''></option>
  <option value=""></option>
  <option value="Yes">Yes</option>
  <option value="No">No</option></select>

  <select name="hiv_test_result" 
  id="hiv_test_result" 
  tt_pageStyleClass="NoKeyboard" 
  allowFreeText="false" 
  tt_onLoad="showCategory2('HIV/ART status');changeNextButton();"
  condition="__$('hiv_test_done_today?').value.match(/YES/i)" 
  helpText="HIV Test result"><option value=''></option>
  <option value=""></option>
  <option value="Positive">Positive</option>
  <option value="Negative">Negative</option>
  <option value="Indeterminate">Indeterminate</option></select>

  <select name="hiv_test_not_done_reason" 
  id="hiv_test_not_done_reason" 
  tt_pageStyleClass="NoKeyboard" 
  allowFreeText="false" 
  tt_onLoad="showCategory2('HIV/ART status');changeNextButton();"
  condition="__$('hiv_test_done_today?').value.match(/NO/i)" 
  helpText="Reason HIV Test not done"><option value=''></option>
  <option value=""></option>
  <option value="Refused">Refused</option>
  <option value="Previous Positive">Previous Positive</option>
  <option value="No Reagents available">No Reagents available</option></select>

</form>
        <div id="footer">
        </div>
      </div>
    </div>
  </body>
</html>

<script type="text/javascript">

  var patientID = sessionStorage.patientID;
  var patientID = sessionStorage.getItem("patientID");
  var programID = sessionStorage.getItem("programID");
  var tstCurrentDate = moment(tstCurrentDate).format("YYYY-MM-DD");
  var tt_cancel_destination = "/views/patient_dashboard.html?patient_id=" + patientID;

    function changeNextButton() {
        var nextButton =  document.getElementById('nextButton');
        nextButton.setAttribute("onmousedown","postHivStatus();")
    }
    

    function postHivStatus() {
        var currentTime = moment().format(' HH:mm:ss');
        var encounter_datetime = moment(sessionStorage.sessionDate).format('YYYY-MM-DD');
        encounter_datetime += currentTime;

        var encounter = {
            encounter_type_name: 'UPDATE HIV STATUS',
            encounter_type_id:  39,
            patient_id: sessionStorage.patientID,
            encounter_datetime: encounter_datetime
        };

        submitParameters(encounter, "/encounters", "postHivStatusObs");
    }

    function postHivStatusObs(encounter) {

        var hivStatusUpdate = document.getElementById('known_hiv_positive').value;
        var artStatus = document.getElementById('currently_taking_arvs').value;
        var hivTestDone = document.getElementById('hiv_test_done_today?').value;
        var currentHivStatus = document.getElementById('hiv_test_result').value;
        var hivNotDone = document.getElementById('hiv_test_not_done_reason').value;

        var conceptAnswers = [
            //Yes No answers
            {
              "yes": 1065,
              "no": 1066
            },
            //Yes No answers
            {
              "yes": 1065,
              "no": 1066
            },
            //Yes No answers
            {
              "yes": 1065,
              "no": 1066
            },
            //Status update
            {
                "positive": 703,
                "negative": 664,
                "indeterminate": 1138
            },
            // Reason HIV Test not done
            {
                "refused": 9601,
                "previousPositive": 9602,
                "noReagentsAvailable": 9603
            }
        ];

        var hivStatusUpdateAnswer;
        var artStatusAnswer;
        var hivTestDoneAnswer;
        var hivStatusAnswer;
        var hivNotDoneAnswer;
        switch (hivStatusUpdate.toUpperCase()) {
            case 'YES':
                hivStatusUpdateAnswer = conceptAnswers[0].yes;
                break;
            case 'NO':
                hivStatusUpdateAnswer = conceptAnswers[0].no;
                break;
            default:
                break;
        }
        switch (artStatus.toUpperCase()) {
            case 'YES':
                artStatusAnswer = conceptAnswers[1].yes;
                break;
            case 'NO':
                artStatusAnswer = conceptAnswers[1].no;
                break;
            default:
                break;
        }
        switch (hivTestDone.toUpperCase()) {
            case 'YES':
                hivTestDoneAnswer = conceptAnswers[2].yes;
                break;
            case 'NO':
                hivTestDoneAnswer = conceptAnswers[2].no;
                break;
            default:
                break;
        }
        switch (currentHivStatus.toUpperCase()) {
            case 'POSITIVE':
                hivStatusAnswer = conceptAnswers[3].positive;
                break;
            case 'NEGATIVE':
                hivStatusAnswer = conceptAnswers[3].negative;
                break;
            case 'INDETERMINATE':
                hivStatusAnswer = conceptAnswers[3].indeterminate;
                break;
        }    
        switch (hivNotDone.toUpperCase()) {
            case 'REFUSED':
                hivNotDoneAnswer = conceptAnswers[4].refused;
                break;
            case 'PREVIOUS POSITIVE':
                hivNotDoneAnswer = conceptAnswers[4].previousPositive;
                break;
            case 'NO REAGENTS AVAILABLE':
                hivNotDoneAnswer = conceptAnswers[4].noReagentsAvailable;
        }

            var obs = {
            encounter_id: encounter["encounter_id"],
            observations: [
                { concept_id: 9566, value_coded: hivStatusUpdateAnswer},
                { concept_id: 9567, value_coded: artStatusAnswer},
                { concept_id: 9568, value_coded: hivTestDoneAnswer},
                { concept_id: 9228, value_coded: hivStatusAnswer },
                { concept_id: 9569, value_coded: hivNotDoneAnswer }
            ]
        };
        submitParameters(obs, "/observations", "nextPage")
        return;
    }

  function nextPage(){
          window.location.href =  "/views/patient_dashboard.html?patient_id=" + patientID;
    }

</script>
